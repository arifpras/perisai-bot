# Presentation Generator Integration Guide

Generate multi-page PDF and PowerPoint presentations from LLM responses.

## Files Created

1. **presentation_generator.py** - Complete presentation generation library
2. **presentation_requirements.txt** - Dependencies needed
3. **PRESENTATION_INTEGRATION.md** - This integration guide

## What's Supported

### PDF Presentations
- Professional formatting with reportlab
- Multi-page documents with custom styling
- Title pages, bullet points, tables, paragraphs
- Color-coded headings and styling
- Automatic page breaks between slides

### PowerPoint Presentations (PPTX)
- Native PowerPoint files using python-pptx
- Multiple slide layouts (title, content, bullets, tables)
- Professional color schemes
- Bullet point formatting
- Table generation from pipe-separated data

## Installation

### Step 1: Install Dependencies

```bash
pip install -r presentation_requirements.txt
```

This installs:
- `reportlab>=4.0.0` - PDF generation
- `python-pptx>=0.6.21` - PowerPoint generation

### Step 2: Copy File to Project

Copy `presentation_generator.py` to your project directory (same location as `telegram_bot.py`).

### Step 3: Import in telegram_bot.py

Add this import at the top:
```python
from presentation_generator import get_file_extension_and_bytes
import io
```

## Usage

### Basic Usage

```python
from presentation_generator import generate_pdf, generate_pptx

# Generate PDF
content = "# My Title\n## Slide 1\nSome content..."
pdf_bytes = generate_pdf(content, title="My Presentation")

# Generate PPTX
pptx_bytes = generate_pptx(content, title="My Presentation")
```

### Expected Content Format

The library expects markdown-style content:

```
# Presentation Title

## Slide 1: Introduction
Introduction paragraph explaining the topic.
More details here.

## Slide 2: Key Points
- First point
- Second point
- Third point

## Slide 3: Data Table
| Column 1 | Column 2 | Column 3 |
| Data 1   | Data 2   | Data 3   |
| Data 4   | Data 5   | Data 6   |

## Slide 4: Conclusion
Final thoughts and summary...
```

## Integration with telegram_bot.py

### Option 1: Modify /kei Command

In the `kei_command()` function, add before the existing command handling:

```python
async def kei_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """/kei <question> ‚Äî ask persona Kei (ChatGPT)."""
    start_time = time.time()
    user_id = update.message.from_user.id
    username = update.message.from_user.username or f"user_{user_id}"
    
    if not is_user_authorized(user_id):
        await update.message.reply_text("‚õî Access denied.")
        return

    question = " ".join(context.args).strip() if context.args else ""
    if not question:
        await update.message.reply_text("Usage: /kei <question>")
        return
    
    # NEW: Check for presentation generation requests
    question_lower = question.lower()
    
    if "generate pdf" in question_lower or "pdf presentation" in question_lower:
        try:
            # Get content from Kei
            await context.bot.send_chat_action(chat_id=update.message.chat_id, action="typing")
            content = await ask_kei(question)
            
            if content:
                from presentation_generator import generate_pdf
                pdf_bytes = generate_pdf(content, title=question)
                
                if pdf_bytes:
                    await update.message.reply_document(
                        document=io.BytesIO(pdf_bytes),
                        filename="presentation.pdf",
                        caption="üìÑ PDF Presentation generated by Kei"
                    )
                    
                    response_time = time.time() - start_time
                    metrics.log_query(user_id, username, question, "pdf", response_time, True, persona="kei")
                    return
                else:
                    await update.message.reply_text("‚ùå PDF generation failed. Is reportlab installed?")
            return
        except Exception as e:
            logger.error(f"PDF generation error: {e}")
            await update.message.reply_text(f"‚ùå Error: {str(e)[:100]}")
            return
    
    elif "generate pptx" in question_lower or "powerpoint" in question_lower:
        try:
            # Get content from Kei
            await context.bot.send_chat_action(chat_id=update.message.chat_id, action="typing")
            content = await ask_kei(question)
            
            if content:
                from presentation_generator import generate_pptx
                pptx_bytes = generate_pptx(content, title=question)
                
                if pptx_bytes:
                    await update.message.reply_document(
                        document=io.BytesIO(pptx_bytes),
                        filename="presentation.pptx",
                        caption="üìä PowerPoint Presentation generated by Kei"
                    )
                    
                    response_time = time.time() - start_time
                    metrics.log_query(user_id, username, question, "pptx", response_time, True, persona="kei")
                    return
                else:
                    await update.message.reply_text("‚ùå PowerPoint generation failed. Is python-pptx installed?")
            return
        except Exception as e:
            logger.error(f"PowerPoint generation error: {e}")
            await update.message.reply_text(f"‚ùå Error: {str(e)[:100]}")
            return
    
    # ... rest of existing kei_command code ...
```

### Option 2: Create Separate /pdf and /pptx Commands

```python
async def pdf_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """/pdf <question> ‚Äî generate PDF presentation from Kei."""
    start_time = time.time()
    user_id = update.message.from_user.id
    username = update.message.from_user.username or f"user_{user_id}"
    
    if not is_user_authorized(user_id):
        await update.message.reply_text("‚õî Access denied.")
        return

    question = " ".join(context.args).strip() if context.args else ""
    if not question:
        await update.message.reply_text("Usage: /pdf <topic>")
        return
    
    try:
        await context.bot.send_chat_action(chat_id=update.message.chat_id, action="typing")
        
        # Get content from Kei
        content = await ask_kei(f"Create a comprehensive presentation about: {question}")
        
        if not content:
            await update.message.reply_text("‚ö†Ô∏è Kei returned empty response.")
            return
        
        from presentation_generator import generate_pdf
        pdf_bytes = generate_pdf(content, title=question)
        
        if pdf_bytes:
            await update.message.reply_document(
                document=io.BytesIO(pdf_bytes),
                filename="presentation.pdf",
                caption=f"üìÑ PDF: {question}"
            )
            
            response_time = time.time() - start_time
            metrics.log_query(user_id, username, question, "pdf", response_time, True, persona="kei")
        else:
            await update.message.reply_text("‚ùå PDF generation failed.")
    
    except Exception as e:
        logger.error(f"PDF command error: {e}")
        await update.message.reply_text(f"‚ùå Error: {str(e)[:100]}")


async def pptx_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """/pptx <question> ‚Äî generate PowerPoint presentation from Kei."""
    start_time = time.time()
    user_id = update.message.from_user.id
    username = update.message.from_user.username or f"user_{user_id}"
    
    if not is_user_authorized(user_id):
        await update.message.reply_text("‚õî Access denied.")
        return

    question = " ".join(context.args).strip() if context.args else ""
    if not question:
        await update.message.reply_text("Usage: /pptx <topic>")
        return
    
    try:
        await context.bot.send_chat_action(chat_id=update.message.chat_id, action="typing")
        
        # Get content from Kei
        content = await ask_kei(f"Create a comprehensive presentation about: {question}")
        
        if not content:
            await update.message.reply_text("‚ö†Ô∏è Kei returned empty response.")
            return
        
        from presentation_generator import generate_pptx
        pptx_bytes = generate_pptx(content, title=question)
        
        if pptx_bytes:
            await update.message.reply_document(
                document=io.BytesIO(pptx_bytes),
                filename="presentation.pptx",
                caption=f"üìä PowerPoint: {question}"
            )
            
            response_time = time.time() - start_time
            metrics.log_query(user_id, username, question, "pptx", response_time, True, persona="kei")
        else:
            await update.message.reply_text("‚ùå PowerPoint generation failed.")
    
    except Exception as e:
        logger.error(f"PPTX command error: {e}")
        await update.message.reply_text(f"‚ùå Error: {str(e)[:100]}")


# Add to create_telegram_app():
def create_telegram_app(token: str) -> Application:
    # ... existing code ...
    
    application.add_handler(CommandHandler("pdf", pdf_command))
    application.add_handler(CommandHandler("pptx", pptx_command))
    
    return application
```

## Usage Examples

### Example 1: Generate PDF
```
User: /pdf Indonesia bond market analysis

Bot:
1. Calls Kei to generate content
2. Parses content into slides
3. Generates PDF with formatting
4. Sends PDF file to user
```

### Example 2: Generate PowerPoint
```
User: /pptx quarterly financial review 2025

Bot:
1. Calls Kei to generate content
2. Parses content into PowerPoint slides
3. Applies professional styling
4. Sends PPTX file to user
```

### Example 3: From /kei Command
```
User: /kei generate pdf about auction trends

Bot:
1. Detects "generate pdf" keyword
2. Calls Kei with the question
3. Generates PDF from response
4. Sends file to user
```

## Content Format

### Supported Markdown Syntax

```markdown
# Main Title

## Slide Title
Regular paragraph content.

## Slide with Bullets
- First bullet point
- Second bullet point
- Third bullet point

## Table Slide
| Header 1 | Header 2 | Header 3 |
| Row 1    | Data 1   | Value 1  |
| Row 2    | Data 2   | Value 2  |

## Conclusion
Final summary paragraph.
```

### Slide Types Auto-Detection

- **Bullets**: Lines starting with `-`, `*`, or `‚Ä¢`
- **Tables**: Lines containing `|` separator
- **Conclusion**: Titles containing "conclusion", "summary", "key point"
- **Content**: Regular paragraphs

## Configuration

Edit these constants in `presentation_generator.py`:

```python
COLORS = {
    'primary': '#1F4788',      # Dark blue (headings)
    'secondary': '#2E5C8A',    # Medium blue (subheadings)
    'accent': '#E74C3C',       # Red (highlights)
    'text': '#2C3E50',         # Dark gray (body text)
    'light_gray': '#ECF0F1',   # Light gray (backgrounds)
    'white': '#FFFFFF',
}

FONTS = {
    'title': 24,
    'heading': 16,
    'subheading': 14,
    'body': 11,
    'small': 10,
}
```

## Graceful Degradation

If dependencies aren't installed:
- Missing `reportlab` ‚Üí PDF generation returns `None`, user gets message
- Missing `python-pptx` ‚Üí PPTX generation returns `None`, user gets message
- Bot continues working without crashing

## Features

‚úÖ Automatic slide parsing from markdown-style content
‚úÖ Professional color schemes and formatting
‚úÖ Multiple slide types (bullets, tables, paragraphs)
‚úÖ PDF with title pages and custom styling
‚úÖ Native PowerPoint files with multiple layouts
‚úÖ Error handling with user-friendly messages
‚úÖ Integration with metrics logging
‚úÖ Graceful degradation if dependencies missing
‚úÖ Text truncation for LLM context limits

## Troubleshooting

### "reportlab not installed"
Install: `pip install reportlab`

### "python-pptx not installed"
Install: `pip install python-pptx`

### PDF has no content
- Kei returned empty response
- Content format doesn't match expected structure
- Check LLM response starts with `# Title` and `## Slide` format

### PowerPoint missing slides
- Content not properly formatted
- No `##` headers found for slide breaks
- Verify content starts with `# Title`

### Large file generation is slow
- Normal for 50+ page documents
- Reportlab/python-pptx require processing time
- Show typing indicator to user while processing

## Performance

- PDF generation: 1-3 seconds for typical presentation
- PPTX generation: 2-5 seconds for typical presentation
- File size: 100KB-500KB depending on content length
- Memory: < 50MB for typical documents

## Notes

- Content is auto-split by `##` headers into slides
- First `#` header becomes presentation title
- Line starting with `-`, `*`, `‚Ä¢` become bullets
- Lines with `|` are parsed as tables
- Bullet detection is automatic; content type not always perfect
- For table data, use pipe-separated format: `| col1 | col2 | col3 |`
